<html>
  <head>
    <title>GGP.org - Apollo Gaming Server</title>
    <meta name="description" content="General game playing is about playing games that you've never seen before. Watch intelligent computers play games against each other here!" />  
    <link rel="shortcut icon" href="http://www.ggp.org/favicon.ico">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans:bold">
    <link rel="stylesheet" type="text/css" href="/apollo.css" />
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/Analytics.js'></script>
  </head>
  <body>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/ResourceLoader.js'></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/UserInterface.js'></script>
    <script type="text/javascript" src="/apolloHeader.js"></script>

    <div id='header'></div>
    <br>
    <center>    
      <div id='playerDiv'></div><br>
      <div id='playerStatsDiv'></div><br>
      <div id='playerStatsPuzzleDiv'></div><br>
      <div id='playerStatsTableDiv'></div><br>
    </center>
    <div id='playerMatchesDiv'></div>

    <script type='text/javascript'>
      generateHeader(document.getElementById('header'));

      cleanFloat = function (x) { return Math.round(x*100)/100; };
      function clip(s, n) {
        if (s.length <= n) return s;
        return s.substring(0,n-3) + "...";
      }
      function renderAvg(x) {
        var y = JSON.parse(x);
        return '<table width=100% padding=0px cellspacing=0px><tr><td width=100%><b>' + cleanFloat(y[0]) + '</b></td><td><i>' + y[1] + '</i></td></tr></table>';
      }
      
      // Load in the game metadata used to render various tables
      var gameMetadata = ResourceLoader.load_json('//games.ggp.org/games/metadata');
      getGameName = function (gameKey) { return gameMetadata[gameKey.replace("http://games.ggp.org/games/", "").split("/")[0]].gameName; }

      // special code for rendering Alex's win/tie/loss table
      function renderWinLossTable(theTable, perPlayer, perGame, avgScore) {
        var theCols = [];
        for (var aPlayer in theTable) {
          for (var aGame in theTable[aPlayer]) {
            if (theCols.indexOf(aGame) == -1) {
              theCols.push(aGame);
            }
          }
        }
        var theTableHTML = "<table border=1px>";
        theTableHTML += "<tr><th colspan=" + (theCols.length+2) + ">Aggregate Win-Tie-Loss Table</th></tr>";
        theTableHTML += "<tr><th></th><th>Avg Score</th>";
        for (var i = 0; i < theCols.length; i++) {          
          theTableHTML += '<th><a href="/games/' + translateRepositoryIntoCodename(theCols[i]) + '">' + clip(getGameName(theCols[i]),12) + '</a></th>';
        }
        theTableHTML += "</tr>";
        // avg score row
        theTableHTML += "<tr><td><b>Average Score</b></td><td></td>";
        for (var i = 0; i < theCols.length; i++) {
          theTableHTML += '<td>';
          if (theCols[i] in perGame) {
            theTableHTML += renderAvg(perGame[theCols[i]]);
          }
          theTableHTML += '</td>';
        }                
        theTableHTML += "</tr>";        
        // real rows
        for (var aPlayer in theTable) {
          theTableHTML += '<tr>';          
          theTableHTML += '<td><b><a href="/players/' + aPlayer + '">' + aPlayer + '</a></b></td>';
          // avg score column
          theTableHTML += '<td>';
          if (aPlayer in perPlayer) {
            theTableHTML += renderAvg(perPlayer[aPlayer]);
          }
          theTableHTML += '</td>';
          // real columns          
          for (var i = 0; i < theCols.length; i++) {
            theTableHTML += '<td>';
            if (theCols[i] in theTable[aPlayer]) {
              theTableHTML += '<center>' + theTable[aPlayer][theCols[i]] + '</center>';
            }
            theTableHTML += '</td>';
          }
          theTableHTML += '</tr>'; 
        }
        theTableHTML += "</table>";
        return theTableHTML;
      }
      
      function renderPuzzleTable(theWinLossTable, perGameOriginal) {
        var perGame = JSON.parse(JSON.stringify(perGameOriginal));
        for (var aPlayer in theWinLossTable) {
          for (var aGame in theWinLossTable[aPlayer]) {
            if (aGame in perGame) {
              delete perGame[aGame];
            }
          }
        }
        var theTableHTML = "<table border=1px>";
        theTableHTML += "<tr><th colspan=2>Aggregate Puzzle Scores</th></tr>";
        for (var aGame in perGame) {
          theTableHTML += '<tr><td><b><a href="/games/' + translateRepositoryIntoCodename(aGame) + '">' + getGameName(aGame) + '</a></b></td><td>' + renderAvg(perGame[aGame]) + '</td></tr>';
        }
        theTableHTML += "</table>";
        return theTableHTML;
      }

      var playerName = window.location.pathname.replace("/players/", "");      
      var statsJSON = ResourceLoader.load_json('//database.ggp.org/statistics/' + hashedApolloPK + '/players/' + playerName);
      
      if ("winsVersusPlayerOnGame" in statsJSON) {
        document.getElementById('playerStatsPuzzleDiv').innerHTML = renderPuzzleTable(statsJSON.winsVersusPlayerOnGame, statsJSON.averageScoreOn);
        document.getElementById('playerStatsTableDiv').innerHTML = renderWinLossTable(statsJSON.winsVersusPlayerOnGame, statsJSON.averageScoreVersus, statsJSON.averageScoreOn, statsJSON.averageScore);
        delete statsJSON.winsVersusPlayerOnGame;
        delete statsJSON.averageScoreVersus;
        delete statsJSON.averageScoreOn;
      }
      document.getElementById('playerStatsDiv').innerHTML = renderJSON(statsJSON);

      var thePlayer = ResourceLoader.load_json('/data/players/' + playerName);
      var playerHTML = '<center style="display: table; width: 100%">';
      playerHTML += generatePlayerHTML(thePlayer);
      playerHTML += '</center>';
      document.getElementById('playerDiv').innerHTML = playerHTML;
      
      var playerMatchesHTML = '';
      var ongoingMatches = ResourceLoader.load_json('//database.ggp.org/query/filterActiveSet,recent,'+hashedApolloPK).queryMatches;      
      var recentMatches = ResourceLoader.load_json('//database.ggp.org/query/filterPlayer,recent,'+hashedApolloPK+',' + playerName).queryMatches;
      if (recentMatches.length == 0) {
        playerMatchesHTML += '<b>This player has not played in any matches recently.</b>';
      } else {
        var matchListCaption = 'What are the ' + recentMatches.length + ' matches this player has played in recently?';
        playerMatchesHTML += renderMatchEntries(recentMatches, ongoingMatches, matchListCaption, playerName);
      }
      document.getElementById('playerMatchesDiv').innerHTML = playerMatchesHTML;
    </script>
  </body>  
</html>