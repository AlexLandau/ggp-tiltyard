<html>
  <head>
    <title>GGP Apollo Server</title>
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans:bold">
    <link rel="stylesheet" type="text/css" href="/apollo.css" />
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/Analytics.js'></script>
  </head>
  <body>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/ResourceLoader.js'></script>
    <script type="text/javascript" src="/apolloHeader.js"></script>

<style>
th {
  background-image: -webkit-gradient(
    linear,
    left bottom,
    left top,
    color-stop(0.24, #CCC),
    color-stop(0.81, #AAA)
  );
  background-image: -moz-linear-gradient(
    center bottom,
    rgb(230,230,230) 24%,
    rgb(184,184,184) 81%
  );
  font-variant: small-caps;
  font-size: 20px;
}
td.name {
  font-weight:bold;
  width: 200px;
}
</style>

    <div id='header'></div>
    <br>
    <center>

      <table width=100%><tr><td width=10%></td><td valign=top width=150px>
        <center>
        <table id="leaderboard" border=1px bgcolor=#CCC cellpadding=5px>
          <tr><th colspan=5>Leaderboard</th></tr>
          <tr><th>Player</th><th>Matches</th><th>Average Score</th><th>PlayerRank</th></tr>
        </table>
        </center>
      </td><td valign=top width=150px>
        <center>
        <table id="server_stats" border=1px bgcolor=#CCC cellpadding=5px>
          <th colspan=2>Server Statistics</th>
        </table>
        </center>
      </td><td width=10%></td></tr></table>

      <br>
      Click <a href="/data/statistics/refresh">here</a> to force a stats refresh. This may take a few seconds.
    </center>

    <script type='text/javascript'>
      generateHeader(document.getElementById('header'));
      
      var statsJSON = ResourceLoader.load_json('/data/statistics/overall');

      cleanFloat = function (x) { return Math.round(x*100)/100; };
      var sortablePairs = [];
      for (var pName in statsJSON.leaderboard) {
        var theBoardStats = JSON.parse(statsJSON.leaderboard[pName]);        
        var thePlayerRank = "";
        if ("playerRank" in statsJSON && pName in statsJSON.playerRank) {
          thePlayerRank = statsJSON.playerRank[pName];
        }
        sortablePairs.push([1*theBoardStats[0], 1*theBoardStats[1], 1*theBoardStats[2], thePlayerRank, pName]);
      }
      sortablePairs.sort(function(a,b){return(b[0]-a[0]);});
      leadersHTML = "";
      for (var i = 0; i < sortablePairs.length; i++) {
        var playerName = sortablePairs[i][4];
        leadersHTML += '<tr><td class="name"><a class="darklink" href=/players/'+playerName+'>'+playerName+'</a></td>';
        leadersHTML += '<td>'+cleanFloat(sortablePairs[i][2])+'</td>'
        leadersHTML += '<td>'+cleanFloat(sortablePairs[i][0])+'</td>'
        leadersHTML += '<td>'+cleanFloat(sortablePairs[i][3])+'</td></tr>'
        // TODO: add back information about the decayed leaderboard
        //'<td>'+cleanFloat(statsJSON.decayedLeaderboard[sortablePairs[i][1]])+'</td></tr>'; 
      }
      document.getElementById('leaderboard').children[0].innerHTML += leadersHTML;
      
      var varNameMapping = {
        "matches": "Total Matches",
        "matchesFinished": "Matches Finished",
        "matchesAbandoned": "Matches Abandoned",
        "matchesStatErrors": "Matches Unreadable",
        "computeTime": "Time Updating Stats",
        "matchesPerDayMedian": "Median Matches/Day",
        "matchesInPastHour": "Matches in Past Hour",
        "matchesInPastDay": "Matches in Past Day",
        "computedAt": "Stats Last Updated",
        "matchesAverageMoves": "Average Moves/Match",
        "matchesAveragePlayers": "Average Players/Match",
        "playerRankError": "PlayerRank Error",
        "playerRankVersion": "PlayerRank Version",
        "playerRankDelta": "PlayerRank Delta"
      };
      
      delete statsJSON.leaderboard;
      delete statsJSON.decayedLeaderboard;
      delete statsJSON.playerRank;
      
      varsHTML = "";
      for (var varName in statsJSON) {
        var varProperName = varName;
        if (varNameMapping[varName]) varProperName = varNameMapping[varName];
        var varValue = cleanFloat(statsJSON[varName]);        
        if (varName == "computedAt") varValue = Math.round((new Date() - 1*statsJSON[varName])/1000) + 's ago';  
        varsHTML += '<tr><td class="name">'+varProperName+'</td><td>'+varValue+'</td></tr>';
      }
      document.getElementById('server_stats').children[0].innerHTML += varsHTML;
      
      //document.getElementById('stats').innerHTML = renderJSON(statsJSON);
    </script>
  </body>  
</html>